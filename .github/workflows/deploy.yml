name: Mirror from Gitea and Deploy

on:
  # Trigger manually via GitHub UI
  workflow_dispatch:
  # Optional: Check for updates every hour
  schedule:
    - cron: '0 * * * *'

# Grant write permission to GITHUB_TOKEN so it can push
permissions:
  contents: write

jobs:
  mirror-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout GitHub repository
        uses: actions/checkout@v3

      - name: Setup Git
        run: |
          git config user.name "irfanrp"
          git config user.email "ipratama209@gmail.com"

      - name: Mirror Content from Gitea
        run: |
          # 1. Clone Gitea repo to a temp folder (with retry)
          n=0
          until [ "$n" -ge 5 ]
          do
             if git clone --depth 1 https://gitea.com/irfanrp/irfanrp.github.io.git temp_gitea; then
                break
             fi
             n=$((n+1))
             echo "Clone failed, retrying in 5 seconds..."
             sleep 5
          done
          
          # Check if clone succeeded
          if [ ! -d "temp_gitea" ]; then
            echo "Failed to clone after 5 attempts"
            exit 1
          fi
          
          # 2. Delete everything in CURRENT dir except .git, .github, AND temp_gitea
          find . -maxdepth 1 ! -name '.git' ! -name '.github' ! -name 'temp_gitea' ! -name '.' ! -name '..' -exec rm -rf {} +
          
          # 3. Move files from temp_gitea to current dir
          cp -a temp_gitea/. .
          rm -rf temp_gitea .git/modules

          # 4. Commit and Push
          git add .
          git commit -m "Mirror update from Gitea" || echo "No changes to mirror"
          git push origin master